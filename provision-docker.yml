---
- hosts: all
  gather_facts: no
  tasks:
  - name: Read vars from secrets file
    include_vars: "{{ secrets_file }}"
    tags:
      - always

- hosts: all
  gather_facts: yes
  sudo: true
  roles:
    - common
    - iptables
    - {role: tls, tags: [tls]}
  handlers:
    - include: roles/httpd/handlers/main.yml
    - include: roles/nginx/handlers/main.yml

- hosts: storage
  gather_facts: yes
  sudo: true
  roles:
    - { role: mysql, tags: [mysql] }
    - { role: ldap,  tags: ['ldap' ] }

- hosts: php-apps:java-apps
  gather_facts: yes
  sudo: true
  roles:
    - httpd
  handlers:
    - include: roles/httpd/handlers/main.yml
    - include: roles/nginx/handlers/main.yml

- hosts: loadbalancer
  gather_facts: no
  sudo: true
  roles:
    - { role: haproxy2, tags: ['lb'] }

      #- hosts: java-apps
      #  gather_facts: true
      #  sudo: true
      #  vars:
      #    env_lang: java
      #  roles:
      #    - tomcat
      #    - java
      #    - shibboleth
      #    - metadata-exporter
      #    - grouper
      #    - teams
      #    - mujina-idp
      #    - mujina-sp
      #    - authz-server
      #    - voot
      #    - authz-playground
      #    - pdp
      #    - oidc
      #    - aa
      #  handlers:
      #    - include: roles/httpd/handlers/main.yml
      #    - include: roles/nginx/handlers/main.yml
